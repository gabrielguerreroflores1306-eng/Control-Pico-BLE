<!DOCTYPE html>
<html>
<head>
    <title>Pico W Drone Dual Joystick Control</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <style>
        /* Estilos CSS (Sin cambios) */
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            text-align: center; 
            background-color: #f4f7f6; 
            margin: 0; 
            padding: 15px 0; 
            user-select: none; 
            -webkit-user-select: none; 
            touch-action: manipulation;
        }
        h1 { color: #333; margin-bottom: 5px; font-size: 1.5em; }
        
        /* --- Controles de Seguridad y Estado --- */
        .main-control-area { width: 95%; max-width: 800px; margin: 0 auto; }
        .safety-area { 
            display: flex; 
            justify-content: space-around; 
            margin-bottom: 20px; 
            flex-wrap: wrap;
        }
        
        button { 
            padding: 12px 25px; 
            font-size: 16px; 
            margin: 5px; 
            border: none; 
            border-radius: 8px; 
            cursor: pointer; 
            color: white; 
            transition: background-color 0.15s, transform 0.1s; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.1); 
        }
        button:active { transform: scale(0.95); box-shadow: 0 2px 4px rgba(0,0,0,0.2); }

        .btn-connect { background-color: #1abc9c; } 
        .btn-arm { background-color: #27ae60; } 
        .btn-arm.disarmed { background-color: #e74c3c; } 
        .btn-panic { background-color: #c0392b; } 

        #status { font-weight: bold; padding: 8px; border-radius: 4px; margin-top: 10px; background-color: #fff0f0; color: #e74c3c; }
        #status.connected { background-color: #f0fff0; color: #27ae60; }
        #arming-status { font-size: 1.1em; margin-top: 10px; color: #34495e; }

        /* --- Joysticks --- */
        .joystick-container { 
            display: flex; 
            justify-content: space-around; 
            padding: 20px 0; 
            flex-wrap: wrap;
        }
        .joystick-wrapper { margin: 10px; }
        .joystick-label { font-size: 1em; font-weight: bold; margin-bottom: 10px; color: #555; }

        /* EL MARCO DEL JOYSTICK */
        .joystick-area {
            width: 38vw; 
            max-width: 250px; 
            height: 38vw;
            max-height: 250px;
            background-color: #ecf0f1; 
            border: 1px solid #bdc3c7;
            border-radius: 50%; 
            position: relative;
            touch-action: none; 
            box-shadow: inset 0 0 10px rgba(0,0,0,0.1); 
            margin: auto;
            overflow: hidden; 
        }
        
        /* El Handle (El círculo que se mueve) */
        .joystick-handle {
            width: 30%; 
            height: 30%;
            background-color: #3498db; 
            border-radius: 50%;
            position: absolute;
            transform: translate(-50%, -50%); 
            pointer-events: none; 
            box-shadow: 0 0 15px rgba(0, 150, 255, 0.5), 0 0 5px rgba(0,0,0,0.3); 
            transition: all 0.05s ease-out; 
        }

        /* --- Panel de Telemetría --- */
        #telemetry-panel {
            margin: 20px auto; 
            font-size: 1em; 
            background-color: #ffffff; 
            padding: 15px; 
            border-radius: 8px; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            max-width: 400px;
        }
        #telemetry-panel strong { color: #3498db; }
        .tele-value { display: inline-block; min-width: 50px; }

    </style>
</head>
<body>
    <h1>Control remoto drone</h1>
    <p id="arming-status">Estado: DESARMADO</p>

    <div class="main-control-area">
        <div class="safety-area">
            <button class="btn-connect" onclick="connectBLE()">Conectar BLE</button>
            <button id="arm-btn" class="btn-arm disarmed" onclick="toggleArming()">Armar</button>
            <button class="btn-panic" onclick="sendCommand(COMMANDS.KILL)">Detener</button>
        </div>

        <p id="status">Desconectado. Click en conectar.</p>

        <div id="telemetry-panel">
            <strong>Comandos (Setpoint):</strong><br>
            T: <span id="tele-throttle" class="tele-value">0%</span> | 
            Y: <span id="tele-yaw" class="tele-value">0%</span><br>
            P: <span id="tele-pitch" class="tele-value">0°</span> | 
            R: <span id="tele-roll" class="tele-value">0°</span>
        </div>

        <div class="joystick-container">
            <div class="joystick-wrapper">
                <div class="joystick-label">IZQ: ALTURA (Y) / ROTACIÓN (X)</div>
                <div id="joystick-left" class="joystick-area">
                    <div id="handle-left" class="joystick-handle"></div>
                </div>
            </div>

            <div class="joystick-wrapper">
                <div class="joystick-label">DER: PITCH (Y) / ROLL (X)</div>
                <div id="joystick-right" class="joystick-area">
                    <div id="handle-right" class="joystick-handle"></div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // --- CONFIGURACIÓN Y UUIDS ---
        const SERVICE_UUID_SHORT = 'bbbb'; 
        const CONTROL_UUID_SHORT = 'bbbc'; 
        
        let device, controlCharacteristic;
        let isArmed = false;
        let controlInterval = null;
        
        const statusElement = document.getElementById('status');
        const armBtn = document.getElementById('arm-btn');
        const armingStatusElement = document.getElementById('arming-status');

        const COMMANDS = {
            ARM: 200,
            DISARM: 201,
            KILL: 255, 
        };

        let THROTTLE_VAL = 0;   
        let YAW_VAL = 127;      
        let PITCH_VAL = 127;    
        let ROLL_VAL = 127;     

        // ✅ AJUSTE CLAVE 3: Ángulo Máximo de Inclinación a 30 grados
        const MAX_TILT_ANGLE = 30; 
        // ✅ AJUSTE CLAVE 4: Porcentaje máximo de rotación limitado al 30%
        const MAX_YAW_PCT = 30; 

        function getUuid(shortUuid) {
            return '0000' + shortUuid + '-0000-1000-8000-00805f9b34fb';
        }

        // --- LÓGICA DE ENVÍO Y SEGURIDAD ---

        function toggleArming() {
            if (!controlCharacteristic) return;

            if (isArmed) {
                sendCommand(COMMANDS.DISARM);
                clearInterval(controlInterval);
                handleEnd('left');  
                handleEnd('right');
                THROTTLE_VAL = 0;   
                sendFlightData(); 
            } else {
                sendCommand(COMMANDS.ARM);
                controlInterval = setInterval(sendFlightData, 100); 
            }
            
            isArmed = !isArmed;
            armBtn.textContent = isArmed ? "DESARMAR" : "ARMAR";
            armBtn.classList.toggle('disarmed', !isArmed);
            armingStatusElement.textContent = `Estado: ${isArmed ? "ARMADO" : "DESARMADO"}`;
        }
        
        async function sendCommand(commandCode) {
            if (!controlCharacteristic) return;
            
            const data = new Uint8Array([commandCode, 0, 0, 0]); 
            
            try {
                await controlCharacteristic.writeValue(data);
                if (commandCode === COMMANDS.KILL) { onDisconnected(); } 
            } catch (error) {
                statusElement.textContent = 'Error BLE. Reconectando...';
                controlCharacteristic = null;
            }
        }

        async function sendFlightData() {
            if (!controlCharacteristic && isArmed) return;

            // 1. Mapeo para feedback visual (usa 30 grados y 30% de Yaw)
            const PITCH_ANGLE = Math.round(mapRange(PITCH_VAL, 0, 255, -MAX_TILT_ANGLE, MAX_TILT_ANGLE));
            const ROLL_ANGLE = Math.round(mapRange(ROLL_VAL, 0, 255, -MAX_TILT_ANGLE, MAX_TILT_ANGLE));
            const YAW_PCT = Math.round(mapRange(YAW_VAL, 0, 255, -MAX_YAW_PCT, MAX_YAW_PCT));
            const THROTTLE_PCT = Math.round(mapRange(THROTTLE_VAL, 0, 255, 0, 100));

            // 2. Mostrar los valores en el panel de telemetría 
            document.getElementById('tele-throttle').textContent = `${THROTTLE_PCT}%`;
            document.getElementById('tele-pitch').textContent = `${PITCH_ANGLE}°`;
            document.getElementById('tele-roll').textContent = `${ROLL_ANGLE}°`;
            document.getElementById('tele-yaw').textContent = `${YAW_PCT}%`;
            
            if (isArmed && controlCharacteristic) {
                // 3. Envío de datos
                const data = new Uint8Array([
                    Math.min(THROTTLE_VAL, 199), 
                    YAW_VAL,                    
                    PITCH_VAL,                  
                    ROLL_VAL                    
                ]);
                
                try {
                    await controlCharacteristic.writeValue(data);
                    statusElement.textContent = `Datos enviados: T:${data[0]} P:${data[2]} R:${data[3]}`;
                } catch (error) {
                    statusElement.textContent = 'Error de transmisión. Reconecte.';
                }
            }
        }
        
        // --- LÓGICA DE MANEJO DE JOYTICK ---

        function mapRange(value, inMin, inMax, outMin, outMax) {
            return (value - inMin) * (outMax - outMin) / (inMax - inMin) + outMin;
        }

        function handleMove(e, areaId) {
            e.preventDefault(); 
            const rect = e.currentTarget.getBoundingClientRect();
            let clientX, clientY;

            if (e.touches) { 
                clientX = e.touches[0].clientX;
                clientY = e.touches[0].clientY;
            } else { 
                clientX = e.clientX;
                clientY = e.clientY;
            }
            
            const centerX = rect.left + rect.width / 2;
            const centerY = rect.top + rect.height / 2;
            const xRel = clientX - centerX;
            const yRel = clientY - centerY;
            
            const maxRadius = rect.width / 2;
            const distance = Math.min(maxRadius, Math.sqrt(xRel * xRel + yRel * yRel));
            const angle = Math.atan2(yRel, xRel);

            const xNorm = maxRadius === 0 ? 0 : distance * Math.cos(angle) / maxRadius;
            const yNorm = maxRadius === 0 ? 0 : distance * Math.sin(angle) / maxRadius;

            const handle = document.getElementById(`handle-${areaId}`);
            handle.style.left = `${(xNorm * 50) + 50}%`; 
            handle.style.top = `${(yNorm * 50) + 50}%`;
            
            // Actualización de variables de valor
            if (areaId === 'left') {
                THROTTLE_VAL = Math.round(mapRange(-yNorm, -1, 1, 0, 255)); 
                YAW_VAL = Math.round(mapRange(xNorm, -1, 1, 0, 255));
            } else if (areaId === 'right') {
                PITCH_VAL = Math.round(mapRange(-yNorm, -1, 1, 0, 255));
                ROLL_VAL = Math.round(mapRange(xNorm, -1, 1, 0, 255));
            }
            
            if (!isArmed) {
                sendFlightData();
            }
        }

        function handleEnd(areaId) {
            const handle = document.getElementById(`handle-${areaId}`);
            
            if (areaId === 'left') {
                handle.style.left = '50%';
                YAW_VAL = 127;
                // Throttle handle debe regresar a 100% (fondo)
                document.getElementById('handle-left').style.top = '100%';
                THROTTLE_VAL = 0;
            } else if (areaId === 'right') {
                handle.style.left = '50%';
                handle.style.top = '50%';
                PITCH_VAL = 127;
                ROLL_VAL = 127;
            }
        }

        // --- Inicialización de Eventos ---
        const setupJoystickEvents = (areaId) => {
            const area = document.getElementById(`joystick-${areaId}`);
            const handle = document.getElementById(`handle-${areaId}`);

            if (areaId === 'left') {
                handle.style.left = '50%'; 
                handle.style.top = '100%'; 
            } else if (areaId === 'right') {
                handle.style.left = '50%'; 
                handle.style.top = '50%'; 
            }
            
            area.addEventListener('pointerdown', (e) => {
                area.setPointerCapture(e.pointerId);
                area.onpointermove = (ev) => handleMove(ev, areaId);
                area.onpointerup = () => {
                    area.onpointermove = null;
                    handleEnd(areaId);
                    if (!isArmed) { sendFlightData(); } 
                };
                handleMove(e, areaId);
            });
        };

        setupJoystickEvents('left');
        setupJoystickEvents('right');
        
        // --- Lógica de Conexión BLE ---
        function onDisconnected(event) {
            statusElement.textContent = 'Desconectado. Volver a conectar.';
            statusElement.classList.remove('connected');
            controlCharacteristic = null;
            clearInterval(controlInterval); 
            isArmed = false;
            armBtn.textContent = "ARMAR";
            armBtn.classList.add('disarmed');
            armingStatusElement.textContent = "Estado: DESARMADO";
            
            handleEnd('left'); 
            handleEnd('right');
        }

        async function connectBLE() {
            if (!navigator.bluetooth) {
                statusElement.textContent = 'Error: Web Bluetooth no es compatible con este navegador.';
                return;
            }
            
            try {
                statusElement.textContent = 'Buscando dispositivo...';
                
                // ✅ AJUSTE CLAVE 5: Nombre del dispositivo BLE (debe coincidir con main.py)
                device = await navigator.bluetooth.requestDevice({
                    filters: [{ name: 'ControlPicoDrone' }],
                    optionalServices: [getUuid(SERVICE_UUID_SHORT)]
                });
                
                device.addEventListener('gattserverdisconnected', onDisconnected);

                statusElement.textContent = 'Conectando a ' + device.name + '...';
                const server = await device.gatt.connect();
                
                const service = await server.getPrimaryService(getUuid(SERVICE_UUID_SHORT));
                controlCharacteristic = await service.getCharacteristic(getUuid(CONTROL_UUID_SHORT));
                
                statusElement.textContent = '¡Conectado! Listo para Armar.';
                statusElement.classList.add('connected');
                
            } catch (error) {
                statusElement.textContent = 'Fallo de conexión: ' + error.message;
                statusElement.classList.remove('connected');
            }
        }
    </script>
</body>
</html>


