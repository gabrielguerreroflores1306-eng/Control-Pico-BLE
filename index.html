<!DOCTYPE html>
<html>
<head>
    <title>Pico W Motor BLE Control</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        body { font-family: Arial, sans-serif; text-align: center; background-color: #f0f0f0; }
        .slider-container { width: 90%; max-width: 500px; margin: 50px auto; padding: 20px; border-radius: 10px; background-color: white; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .slider { width: 100%; height: 35px; }
        button { padding: 12px 25px; font-size: 18px; margin: 10px; border: none; border-radius: 5px; cursor: pointer; background-color: #007bff; color: white; transition: background-color 0.3s; }
        button:hover { background-color: #0056b3; }
        #status { font-weight: bold; margin-top: 15px; color: #dc3545; }
        #status.connected { color: #28a745; }
    </style>
</head>
<body>
    <h1>ðŸš€ Pico W Motor BLE Control</h1>
    <button onclick="connectBLE()">1. Conectar BLE</button>
    
    <div class="slider-container">
        <label for="throttle">2. Acelerador (0-100%): <span id="speed_display">0</span>%</label>
        <input type="range" min="0" max="100" value="0" class="slider" id="throttle" oninput="updateDisplay()" onchange="sendThrottle()">
    </div>
    
    <p id="status">Desconectado. Click en Conectar.</p>
    
    <script>
        // Los UUIDs deben estar en formato de 128 bits
        const SERVICE_UUID_SHORT = 'bbbb'; 
        const THROTTLE_UUID_SHORT = 'bbbc';
        
        let device, throttleCharacteristic;
        const statusElement = document.getElementById('status');
        const throttleSlider = document.getElementById('throttle');
        const speedDisplay = document.getElementById('speed_display');

        // FunciÃ³n de utilidad para convertir UUIDs de 16 bits a 128 bits completos
        function getUuid(shortUuid) {
            return '0000' + shortUuid + '-0000-1000-8000-00805f9b34fb';
        }

        function updateDisplay() {
            speedDisplay.textContent = throttleSlider.value;
        }

        async function connectBLE() {
            if (!navigator.bluetooth) {
                statusElement.textContent = 'Error: Web Bluetooth no es compatible con este navegador.';
                return;
            }
            
            try {
                statusElement.textContent = 'Buscando dispositivo...';
                
                // 1. Solicitar el dispositivo
                device = await navigator.bluetooth.requestDevice({
                    filters: [{ name: 'PicoMotorControl' }],
                    optionalServices: [getUuid(SERVICE_UUID_SHORT)]
                });
                
                device.addEventListener('gattserverdisconnected', onDisconnected);

                // 2. Conectar al GATT Server
                statusElement.textContent = 'Conectando a ' + device.name + '...';
                const server = await device.gatt.connect();
                
                // 3. Obtener Servicio y CaracterÃ­stica
                const service = await server.getPrimaryService(getUuid(SERVICE_UUID_SHORT));
                throttleCharacteristic = await service.getCharacteristic(getUuid(THROTTLE_UUID_SHORT));
                
                statusElement.textContent = 'Â¡Conectado! Mueva el deslizador.';
                statusElement.classList.add('connected');
                
            } catch (error) {
                statusElement.textContent = 'Fallo de conexiÃ³n: ' + error.message;
                statusElement.classList.remove('connected');
            }
        }
        
        function onDisconnected(event) {
            statusElement.textContent = 'Desconectado. Volver a conectar.';
            statusElement.classList.remove('connected');
            throttleCharacteristic = null;
        }

        async function sendThrottle() {
            if (!throttleCharacteristic) return;
            
            const speed = parseInt(throttleSlider.value);
            // El MicroPython espera 1 byte sin signo (<B)
            const data = new Uint8Array([speed]);
            
            try {
                await throttleCharacteristic.writeValue(data);
                // statusElement.textContent = `Velocidad enviada: ${speed}%`;
            } catch (error) {
                statusElement.textContent = 'Error al escribir BLE. Reconectando...';
                throttleCharacteristic = null;
            }
        }
    </script>
</body>
</html>
